<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp Archive Viewer</title>
  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --stroke:rgba(0,0,0,.12);
      --text:#111;
      --muted:#666;
      --blue:#0071e3;
      --incoming:#ffffff;
      --outgoing:#dcf8c6;
      --shadow:0 18px 50px rgba(0,0,0,.10);
      --radius:18px;
      --phoneW: 390px;
      --phoneH: 760px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0 0 10px;font-size:28px;letter-spacing:-.02em}
    .hint{margin:0 0 18px;color:var(--muted);line-height:1.5;font-size:13.5px}
    .grid{
      display:grid;
      grid-template-columns: 1fr var(--phoneW);
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; justify-items:center;}
    }

    .panel{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    label{display:block;font-size:13px;color:#333;margin:12px 0 6px}
    input[type="text"],input[type="file"]{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:12px;
      outline:none;
      background:#fff;
    }
    .row{display:flex; gap:10px; align-items:center; margin-top:14px; flex-wrap:wrap}
    button{
      padding:10px 14px;
      border-radius:12px;
      border:0;
      background:var(--blue);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .ghost{
      background:transparent;
      border:1px solid var(--stroke);
      color:#111;
      font-weight:600;
    }
    .status{margin-top:10px;font-size:13px;color:var(--muted)}
    details{margin-top:12px}
    pre{
      white-space:pre-wrap;
      background:#0b1020;
      color:#d7e0ff;
      border-radius:14px;
      padding:14px;
      overflow:auto;
      max-height: 380px;
    }

    /* Phone mock */
    .phone{
      width:var(--phoneW);
      height:var(--phoneH);
      border-radius:55px;
      background:#0d0d0f;
      padding:9px;
      box-shadow: 0 25px 70px rgba(0,0,0,.25);
      position:sticky;
      top:18px;
    }
    .screen{
      width:100%;
      height:100%;
      border-radius:50px;
      overflow:hidden;
      background:#f2f2f2;
      border:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .topbar{
      height:58px;
      background:#fff;
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 14px;
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .avatar{
      width:34px;height:34px;border-radius:50%;
      background:linear-gradient(135deg,#d9d9d9,#f1f1f1);
      border:1px solid rgba(0,0,0,.06);
      flex:0 0 auto;
    }
    .title{line-height:1.1}
    .title b{display:block;font-size:14px}
    .title span{display:block;font-size:12px;color:#777;margin-top:2px}
   .chatbg{
  position:absolute; inset:58px 0 54px 0;
  overflow:auto;
  padding:14px 10px;
  background-image: url("/assets/wa-wallpaper.png");
  background-repeat: repeat;
  background-size: 520px auto;
  background-color:#eae6df; /* fallback if image not found */
}
    .composer{
      position:absolute; left:0; right:0; bottom:0;
      height:54px;
      background:#fff;
      border-top:1px solid rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 24px;
    }
    .pill{
      flex:1;
      height:34px;
      border-radius:20px;
      border:1px solid rgba(0,0,0,.10);
      background:#fafafa;
    }
    .send{
      width:34px;height:34px;border-radius:50%;
      background:var(--blue);
      opacity:.75;
    }

   /* Messages */
.msg{ display:flex; margin:6px 0; }
.msg.in{ justify-content:flex-start; }
.msg.out{ justify-content:flex-end; }

.bubble{
  max-width: 78%;
  padding:8px 10px;
  border-radius:16px;
  position: relative;
  border: 0;
  box-shadow: 0 1px 1px rgba(0,0,0,.08);
  max-width:82%;
  overflow:visible;        /* IMPORTANT if you added overflow:hidden */
}

.msg.in .bubble{
  background:#fff;
  border-top-left-radius: 4px;
}
.msg.out .bubble{
  background:#d9fdd3; /* modern WA outgoing */
  border-top-right-radius: 4px;
}

/* bubble tails */
.msg.in .bubble::before{
  content:"";
  position:absolute;
  left:-6px;
  top:0;
  width:0;height:0;
  border-top: 10px solid #fff;
  border-left: 10px solid transparent;
}
.msg.out .bubble::before{
  content:"";
  position:absolute;
  right:-6px;
  top:0;
  width:0;height:0;
  border-top: 10px solid #d9fdd3;
  border-right: 10px solid transparent;
}

/* sender label (optional) */
.sender{
  font-size: 11px;
  font-weight: 700;
  color:#1f7a5a;
  margin: 0 0 4px 0;
}

/* text */
.txt{
  font-size:14px;
  line-height:1.35;
  color:#111;              /* IMPORTANT */
  white-space:pre-wrap;
  word-break:break-word;
}

/* bottom-right time like WhatsApp */
.meta{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:4px;
  font-size: 10.5px;
  color: rgba(0,0,0,.45);
}
.meta .who{ display:none; } /* hide "You"/name like real WA */

/* image in chat (no filename UI) */
.imgmsg{
  width:100%;
  display:block;
  border-radius:12px;
}

/* audio in chat (simple WhatsApp style) */
.audiomsg{
  width:100%;
  max-width: 100%;
  height: 34px;
  display:block;
}
    .imgmsg{
  width:100%;
  display:block;
  border-radius:8px;
}

.audiomsg{
  width:260px;
  max-width:100%;
  height:34px;
}
    /* DATE SEPARATOR (WhatsApp style) */
.day{
  width:100%;
  display:flex;
  justify-content:center;
  margin:14px 0;
}

.day span{
  font-size:11px;
  color:#54656f;
  background:#e1f3fb;
  padding:6px 12px;
  border-radius:16px;
  box-shadow:0 1px 1px rgba(0,0,0,.08);
}
    .sysmsg {
  max-width: 90%;
  margin: 12px auto;
  background: #fff3c4;
  color: #5a4b00;
  font-size: 12px;
  padding: 8px 12px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 1px 2px rgba(0,0,0,.05);
}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WhatsApp Archive Viewer</h1>
    <p class="hint">
      Upload a WhatsApp <b>.txt</b> export or a <b>.zip</b> (ZIP must contain a .txt). This page renders the messages as a chat UI.
    </p>

    <div class="grid">
      <!-- Controls -->
      <div class="panel">
        <label>Your name (optional, for outgoing detection)</label>
        <input id="myName" type="text" placeholder="e.g. Ali Mehdi" />

        <label>WhatsApp export (.txt or .zip)</label>
        <input id="file" type="file" />

        <div class="row">
          <button id="btn">Upload & Parse</button>
          <button id="clear" class="ghost" type="button">Clear</button>
        </div>

        <div id="status" class="status">Waiting‚Ä¶</div>

        <details>
          <summary style="cursor:pointer; font-weight:600;">Raw JSON (debug)</summary>
          <pre id="raw">‚Äî</pre>
        </details>
      </div>

      <!-- Phone UI -->
      <div class="phone" aria-label="chat preview">
        <div class="screen">
          <div class="topbar">
            <div class="avatar"></div>
            <div class="title">
              <b id="chatTitle">Chat</b>
              <span id="chatSub">Upload a .txt or .zip export</span>
            </div>
          </div>

          <div id="chat" class="chatbg">
            <div class="empty">Upload a file to preview messages here.</div>
          </div>

          <div class="composer">
            <div class="pill"></div>
            <div class="send"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const btn = document.getElementById('btn');
  const clearBtn = document.getElementById('clear');
  const statusEl = document.getElementById('status');
  const rawEl = document.getElementById('raw');
  const chatEl = document.getElementById('chat');
  const chatTitle = document.getElementById('chatTitle');
  const chatSub = document.getElementById('chatSub');

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDay(iso){
    // iso: "2023-08-30T19:17:07"
    try{
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { weekday:"short", year:"numeric", month:"short", day:"numeric" });
    }catch(e){ return iso?.slice(0,10) || ""; }
  }

  function fmtTime(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleTimeString(undefined, { hour:"numeric", minute:"2-digit" });
    }catch(e){ return ""; }
  }

  function iconFor(type){
    const t = (type||"").toLowerCase();
    if(t.includes("image")) return "üñºÔ∏è";
    if(t.includes("audio")) return "üé§";
    if(t.includes("video")) return "üé¨";
    return "üìé";
  }
function mediaUrl(uploadId, name){
    if(!uploadId || !name) return null;
    return `/api/media/${encodeURIComponent(uploadId)}?name=${encodeURIComponent(name)}`;
  }
  function renderChat(data){
    const messages = Array.isArray(data?.messages) ? data.messages : [];

    chatTitle.textContent = data?.chatName || "Chat";
    chatSub.textContent = messages.length ? `${messages.length} messages` : "No messages parsed (check export format)";

    if(!messages.length){
      chatEl.innerHTML = `<div class="empty">No messages found. Make sure your export looks like:<br><br>
      <code>[30/08/2023, 7:17:07 PM] Name: Message</code></div>`;
      return;
    }

    // Group by day
    let html = "";
    let lastDay = null;

    for(const m of messages){
      const ts = m.timestamp || m.time || m.dateTime || "";
      const dayKey = ts ? String(ts).slice(0,10) : "unknown";
      if(dayKey !== lastDay){
        html += `<div class="day"><span>${esc(fmtDay(ts))}</span></div>`;
        lastDay = dayKey;
      }

     const outgoing = !!m.outgoing;
const side = outgoing ? "out" : "in";
const sender = m.sender || "";

// üëá ADD THIS (very important)
const text = m.text ? m.text.trim() : "";

const attachName = m.attachmentName || "";
const attachType = m.attachmentType || "";

const rawText = (m.text == null) ? "" : String(m.text);
const text = rawText.trim();

const attachName = m.attachmentName || "";
const attachType = m.attachmentType || "";

// bubble content
let content = "";

// sender label for incoming group messages (optional)
if (!outgoing && sender) {
  content += `<div class="sender">${esc(sender)}</div>`;
}

if (attachName) {
  const upId = data?.uploadId || null;
  const url = mediaUrl(upId, attachName);
  const t = (attachType || "").toLowerCase();

  // If no url (user uploaded .txt), we can't serve media
  if (!url) {
    content += `<div class="txt">(attachment)</div>`;
  } else if (t === "image") {
    // ‚úÖ WhatsApp-like: just the image
    content += `<img class="imgmsg" src="${url}" alt="" loading="lazy" />`;
  } else if (t === "audio") {
    // ‚úÖ WhatsApp-like: just the audio player
    content += `
      <audio class="audiomsg" controls preload="none">
        <source src="${url}">
        Your browser does not support audio playback.
      </audio>
    `;
  } else {
    // ‚úÖ Anything else: simple "Open file" link (no filename shown)
    content += `<div class="txt"><a href="${url}" target="_blank" rel="noopener">Open file</a></div>`;
  }

  // optional spacing if message also has text
  if (text) content += `<div style="height:6px"></div>`;
}

if (text) {
  content += `<div class="txt">${esc(text)}</div>`;
}
      const isSystemMessage =
  text.toLowerCase().includes("messages and calls are end-to-end encrypted");

if (!content) {
  content = `<div class="txt" style="color:#777">(empty)</div>`;
}
if (isSystemMessage) {
  html += `
    <div class="sysmsg">
      üîí ${esc(text)}
    </div>
  `;
  continue;
}
     html += `
  <div class="msg ${side}">
    <div class="bubble">
      ${content}
      <div class="meta">
        <span class="who">${outgoing ? "You" : esc(sender || "")}</span>
        <span>${esc(fmtTime(ts))}</span>
      </div>
    </div>
  </div>
`;
    }

    chatEl.innerHTML = html;

    // scroll to bottom
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  async function uploadAndParse(){
    const f = document.getElementById('file').files[0];
    const myName = document.getElementById('myName').value.trim();

    if(!f){
      statusEl.textContent = "Please choose a file first.";
      return;
    }

    btn.disabled = true;
    statusEl.textContent = "Uploading‚Ä¶";

    const fd = new FormData();
    fd.append('file', f);
    if(myName) fd.append('myName', myName);

    try{
      const res = await fetch('/api/upload', { method:'POST', body: fd });
      const text = await res.text();

      // raw debug
      rawEl.textContent = text;

      let data;
      try{ data = JSON.parse(text); }
      catch(e){
        statusEl.textContent = "Server did not return JSON. See Raw JSON.";
        chatEl.innerHTML = `<div class="empty">Unexpected response format. Open ‚ÄúRaw JSON (debug)‚Äù.</div>`;
        return;
      }

      statusEl.textContent = `Done. Parsed ${data?.totalMessages ?? (data?.messages?.length ?? 0)} messages.`;
      renderChat(data);
    }catch(err){
      statusEl.textContent = "Upload failed. Check Render logs.";
      chatEl.innerHTML = `<div class="empty">Network/server error. Try again.</div>`;
      rawEl.textContent = String(err);
    }finally{
      btn.disabled = false;
    }
  }

  btn.addEventListener('click', uploadAndParse);

  clearBtn.addEventListener('click', () => {
    document.getElementById('file').value = "";
    rawEl.textContent = "‚Äî";
    statusEl.textContent = "Cleared.";
    chatTitle.textContent = "Chat";
    chatSub.textContent = "Upload a .txt or .zip export";
    chatEl.innerHTML = `<div class="empty">Upload a file to preview messages here.</div>`;
  });
</script>
</body>
</html>
